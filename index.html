<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Weather website</title>
  <style>
  * {
    box-sizing: border-box;
  }
  [v-cloak]{display: none}
  html, body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
    font-size: 15px;
    word-spacing: 1px;
    color:#333;
    padding: 0;
    margin: 0;
  }

  #app{
    position: relative;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
  }
  .citybutton {
    user-select: none;
    -moz-user-select: none;
    cursor: pointer;
    display: inline-flex;
    flex-direction: column;
    background-color: white;
    position: relative;
    margin: 10px;
    padding: 10px;
    transition: top 0.2s cubic-bezier(.25,.8,.25,1);
    min-width: 50px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    border: 2px solid #bcc;
    top: 0px;
  }

  .citybutton:hover, .citybutton.selected {
    box-shadow:
      0 8px 15px rgba(0,0,0,0.2), 0 5px 5px rgba(0,0,0,0.2);
  }
  .citybutton.selected{
    cursor: default;
    top: 15px;
  }
  .citybutton > *{
    pointer-events: none;
  }
  .cityicon {
    width: 50px;
    height: auto;
    display: block;
    margin: auto;
    padding: 5px;
  }
  #arrow-container {
    position: absolute;
    text-align: center;
    z-index: 1;
    top: calc(50% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #778888;
    padding: 7px 10px;
    transition: all .2s ease-in;
    opacity: 1;
  }

  #arrow-container.down{
    opacity: 0;
    transform: translateX(-50%) scale(0.1) translateY(1000%);
    transition: all .2s ease-in;
  }
  #arrow-container.down .temperature{
    color:transparent;
  }
  #arrow-container h2{
    margin:0 0 5px 0;
    font-size: 21px;
  }
  #arrow-container .temperature{
    font-size: 19px;
  }

  #arrow-container:before{
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 10px solid #778888;
    top: -10px;
    content: '';
    left: 50%;
    margin-left: -10px;
    position: absolute;
  }
  #map{
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1
  }
  .topmenu {
    text-align: center;
  }
  .switch {
    font-size: 50%;
    padding-left: 5px;
    opacity: 0.5;
    cursor: pointer;
  }
  .switch:hover {
    opacity: 1;
  }

  .infocontainer {
    background-color:white;
    border: 2px solid #bcc;
    width: 80%;
    height: 200px;
    align-self: center;
    margin-top: auto;
    margin-bottom: 20px;
  }


  .slidedown-enter-active, .slidedown-leave-active {
    transform: translateY(0%);
    opacity: 1;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }
  .slidedown-enter, .slidedown-leave-to{
    transform: translateY(-100%);
    opacity: 0;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }

  .slideup-enter-active, .slideup-leave-active {
    transform: translateY(0%);
    opacity: 1;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }
  .slideup-enter, .slideup-leave-to{
    transform: translateY(100%);
    opacity: 0;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }

  @media(max-width: 800px) {

    .topmenu {
      display: flex;
    }
    .citybutton {
      width: 60%;
      margin: 0px;
      padding: 0px;
      height: auto;
    }
    .cityname { display: none; }
    .cityicon {
      width: 100%;
      padding: 0;
    }

    #arrow-container {
      position: absolute;
      text-align: center;
      z-index: 1;
      top: auto;
      bottom: calc(50% + 10px);
    }

    #arrow-container:before{
      border-top: 10px solid #778888;
      border-bottom-color: transparent;
      top: auto;
      bottom: -20px;
    }
  }

  </style>
  <script src="/js/vue.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="app">

    <transition name="slidedown" appear>
      <div class="topmenu" v-cloak>
        <div :class="{ citybutton: true, selected: index == selected }" v-on:mouseDown="selected = index" v-for="(loc, index) in locations">
          <img class="cityicon" :src="loc.slug + '.png'" alt="">
          <div class="cityname">{{ loc.name }}</div>
        </div>
      </div>
    </transition>

    <div id="arrow-container" :class="{ down: animating }" v-cloak appear>
      <h2>{{ arrowname }}</h2>
      <span class="temperature">
        {{ currentTemperature }}
        <span v-on:click="celcius = !celcius">
          <span v-if="celcius">°C<span class="switch">°F</span></span>
          <span v-else>°F<span class="switch">°C</span></span>
        </span>
      </span>
    </div>

    <transition name="slideup" appear>
      <div class="infocontainer" v-show="!animating">
        <div class="graph">
          <h3>{{ locations[selected].name }}</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit</p>
        </div>
        <div class="form">
          <label>Input temperature
          <input type="number" /></label>
          <button>submit</button>
        </div>
      </div>
    </transition>

    <vue-map id="map" v-on:started="animating = true" v-on:finished="animating = false" :locations="locations" :selected="selected"></vue-map>
  </div>
</body>

<!--MAP COMPONENT DEPENDENCIES-->
<script src="/js/d3.v3.min.js"></script>
<script src="/js/topojson.v1.min.js"></script>
<script src="/js/world-110m.js"></script>
<!--MAP COMPONENT AS <vue-map> component-->
<script src="/js/vue-map-component.js"></script>

<!-- START OF MAIN VUE SCRIPT -->
<script>

  new Vue({
    el: '#app',
    data: {
      arrowname: '',
      animating: true,
      selected: 0,
      celcius: true,
      userlocation: false,
      locations: [
        { id: 0, latestTemperature: 20, name: 'Tokyo', slug: 'tokyo', coordinates: [139.7328635, 35.6584421], topoindex: 82 },
        { id: 1, latestTemperature: 15, name: 'Helsinki', slug: 'helsinki', coordinates: [24.9490830, 60.1697530], topoindex: 52 },
        { id: 2, latestTemperature: 22, name: 'New York', slug: 'newyork', coordinates: [-73.9938438, 40.7406905], topoindex: 168 },
        { id: 3, latestTemperature: 2, name: 'Amsterdam', slug: 'amsterdam', coordinates: [4.9040238, 52.3650691], topoindex: 117 },
        { id: 4, latestTemperature: 40, name: 'Dubai', slug: 'dubai', coordinates: [55.1562243, 25.092535], topoindex: 3 },
      ]
    },
    watch: {
      animating: function(value) {
        if (value === false) {
          // Rotation animation has stopped, change the values for arrow element.
          // Not using reactive variables to avoid nasty resize animation bugs.
          // Complexity in favor of beuatiful animations, hurray!
          this.arrowname = this.locations[this.selected].name
        }
      }
    },
    created: function() {
      this.socket = io()
      this.socket.on('measurement', this.addMeasurement)

      if (navigator && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude, longitude } = position.coords
          this.userlocation = [longitude, latitude]
        }, console.error)
      }
    },
    computed: {
      currentTemperature: function() {
        const celcius = this.locations[this.selected].latestTemperature
        if (this.celcius) {
          return celcius
        } else {
          return this.fahrenheit(celcius)
        }
      }
    },
    methods: {
      closestLocation: function() {
        if (this.userlocation) {
          const userloc = this.userlocation
          const locationsByDistance =
            this.locations.sort((a, b) => { 
              return this.distance(userloc, a.coordinates) > this.distance(userloc, b.coordinates)
            })

          return locationsByDistance[0]
        }
        return false
      },
      fahrenheit: function(celcius) {
        return (celcius * 9 / 5) + 32
      },
      celcius: function(fahrenheit) {
        return (fahrenheit - 32) * 5 / 9
      },
      addMeasurement: function(measurement) {
        console.log("received measurement", measurement)
        this.locations[measurement.id].latestTemperature =
          measurement.celcius
      }
    }
  })
</script>

</html>