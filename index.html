<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Weather app</title>
  <style>
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
  }
  [v-cloak]{display: none}
  html, body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
    font-size: 15px;
    word-spacing: 1px;
    color:#333;
    padding: 0;
    margin: 0;
  }

  #app{
    position: relative;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
  }
  .citybutton {
    user-select: none;
    -moz-user-select: none;
    cursor: pointer;
    display: inline-flex;
    flex-direction: column;
    background-color: white;
    position: relative;
    margin: 10px;
    padding: 10px;
    min-width: 50px;
    transition: top 0.2s cubic-bezier(.25,.8,.25,1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    border: 2px solid #bcc;
    top: 0px;
  }

  .citybutton:hover, .citybutton.selected {
    box-shadow: 0 8px 15px rgba(0,0,0,0.2), 0 5px 5px rgba(0,0,0,0.2);
  }
  .citybutton.selected{
    cursor: default;
    top: 15px;
  }
  .citybutton > *{
    pointer-events: none;
  }
  .cityicon {
    width: 50px;
    height: auto;
    display: block;
    margin: auto;
    padding: 5px;
  }
  #arrow-container {
    position: absolute;
    text-align: center;
    z-index: 1;
    top: calc(50% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #778888;
    padding: 7px 10px;
    transition: all .2s ease-in;
    opacity: 1;
  }

  #arrow-container.down{
    opacity: 0;
    transform: translateX(-50%) scale(0.1) translateY(1000%);
    transition: all .2s ease-in;
  }
  #arrow-container.down .temperature{
    color:transparent;
  }
  #arrow-container h2{
    margin:0 0 5px 0;
    font-size: 21px;
  }
  #arrow-container .temperature{
    user-select: none;
    -moz-user-select: none;
    font-size: 19px;
  }
  .modal .temperature {
    user-select: none;
    -moz-user-select: none;
    cursor: pointer;
    display: block;
    text-align: center;
    font-size: 28px;
    color:#455;
  }

  #arrow-container:before{
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 10px solid #778888;
    top: -10px;
    content: '';
    left: 50%;
    margin-left: -10px;
    position: absolute;
  }
  #map{
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1
  }
  .topmenu {
    text-align: center;
  }
  .switch {
    font-size: 50%;
    padding-left: 5px;
    opacity: 0.5;
    cursor: pointer;
    vertical-align: middle;
  }

  .infocontainer {
    z-index: 2;
    background-color:white;
    border: 2px solid #bcc;
    height: 200px;
    align-self: center;
    margin-top: auto;
    margin-bottom: 10px;
    padding: 7px 10px;
    text-align: center;
  }

  .flex{display: flex;}
  .rangewrap{
    display: flex;
    margin: 10px -10px 10px -10px;
  }
  .range{
    flex-grow: 1;
    align-self: center;
  }
  .increment{
    font-size: 24px;
    padding: 10px;
    cursor: pointer;
  }
  .modalButton {
    user-select: none;
    -moz-user-select: none;
    cursor: pointer;
    padding: 7px 10px;
    text-align: center;
    margin:10px 0;
    display: inline-block;
    flex-grow: 1;
    transition: all .1s ease-out;
    position: relative;
    top: 0;
    box-shadow:
      3px 3px #bcc, /* bottom right */
      -2px -2px #bcc, /* top left */
      3px -2px #bcc, /* top right */
      -2px 3px #bcc /* bottom left */
  }
  .modalButton[disabled] {
    opacity: 0.5;
  }
  .modalButton:active {
    top:2px;
    box-shadow:
      1px 1px #bcc, /* bottom right */
      -2px -2px #bcc, /* top left */
      1px -2px #bcc, /* top right */
      -2px 1px #bcc /* bottom left */
  }
  .modalContainer {
    z-index: 3;
    position: absolute;
    top: 0;
    left: 0;
    height: 100vh;
    width: 100vw;
    background: rgba(0,0,0,0.5);
  }
  .block { display: block }
  .modal {
    background: white;
    border: 2px solid #bcc;
    padding: 20px 40px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 95%;
  }
  .formfield {padding: 5px 0;}
  .warning {
    color: orange;
  }
  .brief {
    max-width: 400px;
  }
  .flash {
    text-align: center;
    position: relative;
    top: 15px;
    z-index: 3;
    width: 95%;
    max-width: 500px;
    margin: auto;
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  }
  .flash.success {
    background: rgb(120, 200, 100);
  }
  .flash.error {
    background: rgb(230, 120, 100);
  }

  .slidedown-enter-active, .slidedown-leave-active {
    transform: translateY(0%);
    opacity: 1;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }
  .slidedown-enter, .slidedown-leave-to{
    transform: translateY(-100%);
    opacity: 0;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }

  .slideup-enter-active, .slideup-leave-active {
    transform: translateY(0%);
    opacity: 1;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }
  .slideup-enter, .slideup-leave-to{
    transform: translateY(100%);
    opacity: 0;
    transition: all .3s cubic-bezier(0.42, 0, 0.58, 1);
  }


  /* CUSTOM RANGE SLIDER STYLES */
  input[type=range] {
    -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
    width: 100%; /* Specific width is required for Firefox. */
    background: transparent; /* Otherwise white in Chrome */
  }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
  input[type=range]:focus { outline: none; }
  input[type=range]::-moz-focus-outer { border: 0; }
  /* Special styling for WebKit/Blink */
  input[type=range]::-webkit-slider-thumb {
    box-shadow: 1px 1px 1px #111, 0px 0px 1px #0d0d0d;
    -webkit-appearance: none;
    border: 3px solid #bcc;
    height: 30px;
    width: 16px;
    border-radius: 0px;
    background: #fff;
    cursor: pointer;
    margin-top: -14px;
  }
  /* All the same stuff for Firefox */
  input[type=range]::-moz-range-thumb {
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    border: 3px solid #bcc;
    height: 30px;
    width: 16px;
    border-radius: 0px;
    background: #bcc;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-runnable-track {
    width: 100%;
    height: 8.4px;
    cursor: pointer;
    background: #fff;
    border-radius: 0px;
    border: 0.2px solid #bcc;
  }

  input[type=range]:focus::-webkit-slider-runnable-track {
    background: #367ebd;
  }

  input[type=range]::-moz-range-track {
    width: 100%;
    height: 8.4px;
    cursor: pointer;
    background: #fff;
    border-radius: 0;
    border: 0.2px solid #bcc;
  }


  @media(max-width: 800px) {

    .topmenu {
      display: flex;
    }
    .citybutton {
      width: 60%;
      margin: 0px;
      padding: 0px;
      height: auto;
    }
    .cityname { display: none; }
    .cityicon {
      width: 100%;
      padding: 0;
    }
    #arrow-container {
      position: absolute;
      text-align: center;
      z-index: 1;
      top: auto;
      bottom: calc(50% + 10px);
    }

    #arrow-container:before{
      border-top: 10px solid #778888;
      border-bottom-color: transparent;
      top: auto;
      bottom: -20px;
    }

    .infocontainer, .modal {
      width: calc(100% - 20px);
    }
  }

  </style>
  <script src="/js/vue.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="app">

    <!-- MODDAL -->
    <div v-on:click.self="showModal = false" class="modalContainer" v-if="showModal" v-cloak>
      <form v-on:submit.prevent="sendMeasurement" class="modal">
        <p class="warning brief" v-if="locationCheck !== -1">
          Your closest location is {{ locations[locationCheck].name }}. Are you sure you mean to submit to {{ locations[selected].name }}?
        </p>
        <div class="formfield">
          <span class="temperature" v-on:click="useCelcius = !useCelcius">
            {{ locations[selected].name }}: 
            <span v-if="useCelcius">{{ formMeasurement }}°C<span class="switch">°F</span></span>
            <span v-else>{{ formMeasurement }}°F<span class="switch">°C</span></span>
          </span>
          <div class="rangewrap">
            <span class="increment" v-on:click="formMeasurement -= 1">-</span>
            <input class="range" v-model.number="formMeasurement" type="range" :min="minmaxTemperature[0]" :max="minmaxTemperature[1]" step="1"/>
            <span class="increment" v-on:click="formMeasurement += 1">+</span>
          </div>
          <div class="flex">
            <div :disabled="sendDisabled" class="modalButton" v-on:click="sendMeasurement">Submit</div>
          </div>
        </div>
      </form>
    </div>

    <!-- TOP CITY MENU -->
    <transition name="slidedown" appear>
      <div>
        <div class="topmenu" v-cloak>
          <div :class="{ citybutton: true, selected: index == selected }" v-on:mouseDown="selected = index" v-for="(loc, index) in locations">
            <img class="cityicon" :src="loc.slug + '.png'" alt="">
            <div class="cityname">{{ loc.name }}</div>
          </div>
        </div>
        <transition name="slidedown">
          <div v-if="flashMessage.active" :class="flashMessage.className + ' flash'">{{ flashMessage.msg }}</div>
        </transition>
      </div>
    </transition>

    <!-- CENTER MAP ARROW -->
    <div id="arrow-container" :class="{ down: animating }" v-cloak>
      <h2>{{ arrowname }}</h2>
      <span class="temperature">
        {{ currentTemperature | round }}
        <span v-on:click="useCelcius = !useCelcius">
          <span v-if="useCelcius">°C<span class="switch">°F</span></span>
          <span v-else>°F<span class="switch">°C</span></span>
        </span>
      </span>
    </div>

    <!-- BOTTOM ÌNFORMATION BOX -->
    <transition name="slideup" appear>
      <div class="infocontainer" v-show="!animating" v-cloak>
        <div class="graph">
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit</p>
        </div>
          <div class="modalButton" v-on:click="showModal = true">Submit measurement!</div>
      </div>
    </transition>

    <!-- BACKGROUND MAP COMPONENT -->
    <vue-map id="map" v-on:started="animating = true" v-on:finished="animating = false" :locations="locations" :selected="selected"></vue-map>
  </div>
</body>

<!--MAP COMPONENT DEPENDENCIES-->
<script src="/js/d3.v3.min.js"></script>
<script src="/js/topojson.v1.min.js"></script>
<script src="/js/world-110m.js"></script>
<!--MAP COMPONENT AS <vue-map> component-->
<script src="/js/vue-map-component.js"></script>

<!-- START OF MAIN VUE SCRIPT -->
<script>

  new Vue({
    el: '#app',
    data: {
      arrowname: '',
      animating: true,
      showModal: false,
      selected: 0,
      useCelcius: true,
      userlocation: false,
      sending: false,
      disconnected: false,
      flashMessage: {
        active: false,
        className: "",
        msg: ""
      },
      formMeasurement: 0,
      locations: [
        { id: 0, measurements: [20, 21], name: 'Tokyo', slug: 'tokyo', coordinates: [139.7328635, 35.6584421], topoindex: 82 },
        { id: 1, measurements: [20, 21], name: 'Helsinki', slug: 'helsinki', coordinates: [24.9490830, 60.1697530], topoindex: 52 },
        { id: 2, measurements: [20, 21], name: 'New York', slug: 'newyork', coordinates: [-73.9938438, 40.7406905], topoindex: 168 },
        { id: 3, measurements: [20, 21], name: 'Amsterdam', slug: 'amsterdam', coordinates: [4.9040238, 52.3650691], topoindex: 117 },
        { id: 4, measurements: [20, 21], name: 'Dubai', slug: 'dubai', coordinates: [55.1562243, 25.092535], topoindex: 3 },
      ]
    },
    watch: {
      useCelcius: function(usingCelcius) {
        // when we change our degree type change the current measurement value
        if (usingCelcius) {
          this.formMeasurement = Math.round(this.fahrenheitToCelcius(this.formMeasurement))
        } else {
          this.formMeasurement = Math.round(this.celciusToFahrenheit(this.formMeasurement))
        }
      },
      animating: function(value) {
        if (value === false) {
          // Rotation animation has stopped, change the values for arrow element.
          // Not using reactive variables to avoid nasty resize animation bugs.
          // Complexity in favor of beuatiful animations, hurray!
          this.arrowname = this.locations[this.selected].name
        }
      },
      form: function(value) {
        console.log("form changed", value, value.measurement, value.location)
      },
      locationWarning: function(val) {
        console.log("locationWarn", val)
      }
    },
    created: function() {
      this.socket = io()
      // receive live data from the server
      this.socket.on('update', this.receiveMeasurement)

      const genericError = (reason) => {
        this.disconnected = true
        console.error("Socket error", reason)
        this.flashMessage = {
          active: true,
          className: "error",
          msg: "Connection error. Try to refresh or come back later."
        }
      }

      // when socket has problems show a generic error
      this.socket.on('disconnect', genericError)
      this.socket.on('connect_error', genericError)
      this.socket.on('connect_timeout', genericError)

      // when socket reconnects remove any lindering flash message
      this.socket.on('reconnect', function() {
        this.disconnected = false
        console.log("socket reconnected")
        this.resetFlash()
      }.bind(this))

      // ask user for gps location
      if (navigator && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude, longitude } = position.coords
          this.userlocation = [longitude, latitude]
        })
      }
    },
    computed: {
      sendDisabled: function() {
        return this.sending || this.disconnected
      },
      minmaxTemperature: function() {
        // returns the max degrees of current setting
        if (this.useCelcius) {
          return [-100, 100]
        } else {
          return [this.celciusToFahrenheit(-100), this.celciusToFahrenheit(100)]
        }
      },
      currentTemperature: function() {
        // reactive computed value of the current locations latest temperature
        const measurements = this.locations[this.selected].measurements
        const celcius = measurements[measurements.length - 1]
        if (this.useCelcius) {
          return celcius
        } else {
          return this.celciusToFahrenheit(celcius)
        }
      },
      locationCheck: function() {
        // returns id of your closest location if it is
        // in conclict with the selected location in the form
        const distance = (x, y) => {
          return Math.sqrt(Math.pow(x[0]-y[0], 2) + Math.pow(x[1]-y[1], 2))
        }

        const getClosestLocation = () => {
          // return id of closest location, on failure return -1
          const userloc = this.userlocation
          if (!userloc) return -1
          const locationsByDistance =
            this.locations.slice().sort((a, b) => { 
              return (
                distance(userloc, a.coordinates)
              > distance(userloc, b.coordinates)
              )
            })
          return locationsByDistance[0].id
        }


        const closest = getClosestLocation()
        if (closest !== -1 && closest !== this.selected) {
          return closest
        }
        return -1
      },
      temperatureCheck: function() {

      }
    },
    filters: {
      round: function(value) {
        return Math.round(value)
      }
    },
    methods: {
      sendMeasurement: function() {
        // Since we already have a socket open let's use that
        // instead of a post request
        this.sending = true
        const input = this.formMeasurement
        this.socket.emit('add', {
          id: this.selected,
          celcius: this.useCelcius ? input : this.fahrenheitToCelcius(input)
        }, () => {
          this.showModal = false
          this.sending = false
          this.setFlashMessage("Thank you for your contribution!")
        })
      },
      resetFlash: function() {
        this.flashMessage = {
          active: false,
          msg: "",
          className: ""
        }
      },
      setFlashMessage: function(msg, duration) {
        this.flashMessage = {
          active: true,
          className: "success",
          msg
        }
        setTimeout(this.resetFlash, duration || 3000)
      },
      celciusToFahrenheit: function(celcius) {
        return (celcius * 9 / 5) + 32
      },
      fahrenheitToCelcius: function(fahrenheit) {
        return (fahrenheit - 32) * 5 / 9
      },
      receiveMeasurement: function(measurement) {
        console.log("received measurement", measurement)
        this.locations[measurement.id].measurements.push(measurement.celcius)
      }
    }
  })
</script>

</html>